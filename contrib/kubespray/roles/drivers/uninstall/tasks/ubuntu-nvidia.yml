---
- name: Uninstall nvidia drivers on ubuntu 16.04
  include_tasks: ubuntu-1604-uninstall-nvidia.yml
  when: ansible_distribution_version == '16.04'

- name: Uninstall nvidia drivers on ubuntu 18.04
  include_tasks: ubuntu-1804-uninstall-nvidia.yml
  when: ansible_distribution_version == '18.04'

- name: Remove the drivers repository from Ubuntu
  apt_repository:
    repo: ppa:graphics-drivers/ppa
    state: absent

- name: Run the equivalent of "apt-get update" as a separate step
  apt:
    update_cache: yes

- name: "stop NVIDIA persistent mode"
  raw: "systemctl stop nvidia-persistenced"
  failed_when: false
  changed_when: false
  check_mode: false
  environment: {}

- name: "disable NVIDIA persistent mode"
  raw: "systemctl disable nvidia-persistenced"
  failed_when: false
  changed_when: false
  check_mode: false
  environment: {}

- name: "remove NVIDIA persistent mode's file"
  raw: "rm -rf /etc/systemd/system/nvidia-persistenced.service.d"
  failed_when: false
  changed_when: false
  check_mode: false
  environment: {}

- name: "systemd reload"
  raw: "systemctl daemon-reload"
  failed_when: false
  changed_when: false
  check_mode: false
  environment: {}

- name: "systemd reset-failed"
  raw: "systemctl reset-failed"
  failed_when: false
  changed_when: false
  check_mode: false
  environment: {}

- name: reboot vm
  reboot:
