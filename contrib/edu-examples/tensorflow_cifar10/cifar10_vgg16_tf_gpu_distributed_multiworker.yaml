protocolVersion: 2
name: cifar10_vgg16_tf2_multiWorker_example
type: job
jobRetryCount: 0
prerequisites:
  - type: dockerimage
    uri: 'openpai/standard:python_3.6-tensorflow_2.1.0-gpu'
    name: docker_image_0
taskRoles:
  chief:
    instances: 1
    completion:
      minFailedInstances: 1
      minSucceededInstances: -1
    taskRetryCount: 0
    dockerImage: docker_image_0
    resourcePerInstance:
      gpu: 4
      cpu: 16
      memoryMB: 32768
    commands:
      - >-
        wget
        https://raw.githubusercontent.com/suiguoxin/pai/pai-for-edu/contrib/edu-examples/tensorflow_cifar10/src/cifar10_vgg16_tf_distributed.py
      - >-
        python cifar10_vgg16_tf_distributed.py --epochs 50 --batch_size 32
        --strategy MultiWorkerMirrored 
        --PAI_HOST_IP_chief_0 $PAI_HOST_IP_chief_0
        --PAI_PORT_LIST_chief_0_http $PAI_PORT_LIST_chief_0_http
        --PAI_HOST_IP_worker_0 $PAI_HOST_IP_worker_0
        --PAI_PORT_LIST_worker_0_http $PAI_PORT_LIST_worker_0_http
        --PAI_HOST_IP_worker_1 $PAI_HOST_IP_worker_1
        --PAI_PORT_LIST_worker_1_http $PAI_PORT_LIST_worker_1_http
        --PAI_HOST_IP_worker_2 $PAI_HOST_IP_worker_2
        --PAI_PORT_LIST_worker_2_http $PAI_PORT_LIST_worker_2_http
        --PAI_CURRENT_TASK_ROLE_NAME $PAI_CURRENT_TASK_ROLE_NAME
        --PAI_CURRENT_TASK_ROLE_CURRENT_TASK_INDEX $PAI_CURRENT_TASK_ROLE_CURRENT_TASK_INDEX
  worker:
    instances: 1
    completion:
      minFailedInstances: 1
      minSucceededInstances: -1
    taskRetryCount: 0
    dockerImage: docker_image_0
    resourcePerInstance:
      gpu: 4
      cpu: 16
      memoryMB: 32768
    commands:
      - >-
        wget
        https://raw.githubusercontent.com/microsoft/pai/pai-for-edu/contrib/edu-examples/tensorflow_cifar10/src/cifar10_vgg16_tf_distributed.py
      - >-
        python cifar10_vgg16_tf_distributed.py --epochs 50 --batch_size 32
        --strategy MultiWorkerMirrored 
        --PAI_HOST_IP_chief_0 $PAI_HOST_IP_chief_0
        --PAI_PORT_LIST_chief_0_http $PAI_PORT_LIST_chief_0_http
        --PAI_HOST_IP_worker_0 $PAI_HOST_IP_worker_0
        --PAI_PORT_LIST_worker_0_http $PAI_PORT_LIST_worker_0_http
        --PAI_HOST_IP_worker_1 $PAI_HOST_IP_worker_1
        --PAI_PORT_LIST_worker_1_http $PAI_PORT_LIST_worker_1_http
        --PAI_HOST_IP_worker_2 $PAI_HOST_IP_worker_2
        --PAI_PORT_LIST_worker_2_http $PAI_PORT_LIST_worker_2_http
        --PAI_CURRENT_TASK_ROLE_NAME $PAI_CURRENT_TASK_ROLE_NAME
        --PAI_CURRENT_TASK_ROLE_CURRENT_TASK_INDEX $PAI_CURRENT_TASK_ROLE_CURRENT_TASK_INDEX
defaults:
  virtualCluster: default
extras:
  com.microsoft.pai.runtimeplugin:
    - plugin: ssh
      parameters:
        jobssh: true
