# Goal

Monitoring all compoments in pai, provide insight on detectiving system/hardware failuring and
analysing jobs performance.

# Architecture

![Architecture](architecture.png)

We have three parts consisting Pai's monitoring system: `watchdog`, `exporter` and
[`prometheus`](https://prometheus.io/).

`prometheus` is an open source solution for metrics collecting, storage and querying.

`watchdog` is a single instance pod responsible for monitoring k8s/nodes/pods health, it will first
list all pod/node from kubernetes api server and check their status and log their status, this is very
helpful for debugging.

`exporter` are those pods running in the lefe side of node, they are responsible for collecting
metrics from jobs/nodes/gpus. There are two containers running inside `exporter` pod: `gpu_exporter`
and [`node_exporter`](https://github.com/prometheus/node_exporter): `gpu_exporter` exposes job/gpu
metrics to volume mounted in `/datastorage/prometheus`.

Metrics generated by `watchdog` and `gpu_exporter` are collected by `node_exporter` container running
inside `exporter` pod. Those metrics are scraped by `node_exporter` container. `node_exporter` also
expose node metricss like node cpu/memory/disk usage.

# Metrics collected

Exporter's metrics are listed [here](./exporter-metrics.md).

More metrics are listed [here](./watchdog-metrics.md).

# Build

Build image by using `paictl.py`:
```
./paictl.py image build -p ~/pai-config/ -n gpu-exporter
./paictl.py image build -p ~/pai-config/ -n watchdog
```

push to registry for deploying:

```
./paictl.py image push -p ~/pai-config/ -n gpu-exporter
./paictl.py image push -p ~/pai-config/ -n watchdog
```

# Deployment

start by:

```
./paictl.py service start -p ~/pai-config/ -n prometheus
```

stop by:
```
./paictl.py service stop -p ~/pai-config/ -n prometheus
```

stop and clean data by:
```
./paictl.py service delete -p ~/pai-config/ -n prometheus
```
