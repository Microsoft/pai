# 如何定制报警

OpenPAI支持定制不同的报警规则（Alerting Rules）和相应的处理措施（Action）。具体来说，报警规则是由`prometheus`管理的，而规则和处理措施之间的匹配是由`alert-manager`负责的。

默认情况下，报警只会显示在Webportal中。但是，您可以通过设置`prometheus`和`alert-manager`来实现更多复杂的处理措施。例如，当特定报警产生时，您可以给管理员或相应用户发邮件、给任务打标签。

在本文档中，我们将会介绍现有的报警和处理措施，它们的匹配规则，以及如何自定义新的报警和处理措施。

## 现有的报警和处理措施以及它们是如何匹配的

### 现有的报警规则

OpenPAI使用`prometheus`来监控系统指标。默认情况下，我们给虚拟集群状态、GPU使用率添加了很多报警规则。在OpenPAI成功部署后，您可以通过URI `<master IP>/prometheus/rules`来查看这些报警的细节。

关于报警规则的语法，请参考[这里](https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/)。

### 现有的处理措施

OpenPAI使用`alert-manager`服务来处理不同的报警。目前，我们提供以下几种处理措施：

* webportal-notification： 在Webportal的主页里显示报警（右上角）。
* email-admin： 给对应的管理员发邮件。
* email-user： 给任务的提交者发邮件。
* stop-jobs： 使用OpenPAI REST API结束任务。
* tag-jobs： 使用OpenPAI REST API给任务打标签。

`webportal-notification`会一直被开启，所以用户可以在Webportal上看到所有报警消息。

这些处理措施被实现在`alert-handler`中。管理员需要设置`service-configuration.yml`的`alert-manager`部分来让它们可用。

所有可用的处理措施被保存在 `cluster_cfg["alert-manager"]["actions-available"]`，关于设置细节，请参考[这个文档](https://github.com/microsoft/pai/tree/master/src/alert-manager/config/alert-manager.md)。

如果您使用的是`email-user`、`stop-jobs`、`tag-jobs` `job_name`，请确保在报警消息中含有一个`job_name`字段。

### 报警和处理措施是如何匹配的

匹配规则定义在`receivers`和`ruotes`字段。一个`receiver`是一组处理措施，一个`rule`定义了把哪些报警给哪个`receiver`。

默认设置中，

With the default configuration, all the alerts will match the default alert receiver which triggers only `email-admin` action.
You can add new receivers with related matching rules to assign actions to alerts in the `alert-manager` field in `service-configuration.yml`

For example :

``` yaml
customized-routes:
  routes:
  - receiver: pai-email-admin-user-and-stop-job
    match:
      alertname: PAIJobGpuPercentLowerThan0_3For1h
customized-receivers:
  - name: "pai-email-admin-user-and-stop-job"
    actions: 
      - email-admin
      - email-user
      - stop-jobs
      - tag-jobs
    tags: 
      - 'stopped-by-alert-manager'
```

Here we define :
- a receiver `pai-email-admin-user-and-stop-job`, which contains the actions `email-admin`, `email-user`, `stop-jobs` and `tag-jobs`
- a route, which matches the alert `pai-email-admin-user-and-stop-job` to the receiver `pai-email-admin-user-and-stop-job`.

As a consequence, when the alert `PAIJobGpuPercentLowerThan0_3For1h` is fired, all these 4 actions will be triggered.

For `routes` definition, we adopt the syntax of [Prometheus Alertmanager](https://prometheus.io/docs/alerting/latest/configuration/).
For `receivers` definition, you can simply:
- name the receiver in `name` field;
- list the actions to use in `actions`;
- list the tags in `tags` if `tag-jobs` is one of the actions.

Remember to push service config to the cluster and restart the `alert-manager` service after your modification with the following commands in the dev-box container:
```bash
./paictl.py service stop -n alert-manager
./paictl.py config push -p /cluster-configuration -m service
./paictl.py service start -n alert-manager
```

For alert & action matching rules syntax, please refer to [Prometheus Alertmanager](https://prometheus.io/docs/alerting/latest/configuration/).

For OpenPAI service management, please refer to [Basic Management Operations](https://github.com/microsoft/pai/blob/master/docs/manual/cluster-admin/基础管理操作.md).


## How to Add Customized Alerts

You can define customized alerts in the `prometheus` field in `service-configuration.yml`.
For example, We can add a customized alert `PAIJobGpuPercentLowerThan0_3For1h` by adding :

``` yaml
customized-alerts: |
  groups:
    - name: customized-alerts
      rules:
        - alert: PAIJobGpuPercentLowerThan0_3For1h
          expr: avg(task_gpu_percent{virtual_cluster=~"default"}) by (job_name) < 0.3
          for: 1h
          annotations:
            summary: "{{$labels.job_name}} has a job gpu percent lower than 30% for 1 hour"
            description: Monitor job level gpu utilization in certain virtual clusters.
```

The `PAIJobGpuPercentLowerThan0_3For1h` alert will be fired when the job on virtual cluster `default` has a task level average GPU percent lower than `30%` for more than `1 hour`.
Here the metric `task_gpu_percent` is used, which describes the GPU utilization in task level. 
You can explore the system metrics at `your_master_ip/prometheus/graph`.

Remember to push service config to the cluster and restart the `prometheus` service after your modification with the following commands in the dev-box container:
```bash
./paictl.py service stop -n prometheus
./paictl.py config push -p /cluster-configuration -m service
./paictl.py service start -n prometheus
```

Please refer to [Prometheus Alerting Rules](https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/) for alerting rules syntax.

## How to Add Customized Actions

If you want to add new customized actions, follow these steps:

###  Realize the action in 'alert-handler'.
We provide `alert-handler` as a lightweight `express` application, where you can add customized APIs easily.

For example, the `stop-jobs` action is realized by calling the `localhost:9095/alert-handler/stop-jobs` API through `webhook`,
the request is then forward to the OpenPAI Rest Server to stop the job.
You can add new APIs in `alert-handler` and adapt the request to realize the required action.

The source code of `alert-handler` is available [here](https://github.com/microsoft/pai/blob/master/src/alert-manager/src/alert-handler).

### Check the dependencies of the action

As stated before, to make an action available, administrators need to provide the necessary configurations.
Check this [folder](https://github.com/microsoft/pai/tree/master/src/alert-manager/config) and define the dependencies' rules for your customized actions.


### Render the action to webhook configurations

When customized receivers are defined in `service-configuration.yml`,
the `actions` will then be rendered as webhook_configs [here](https://github.com/microsoft/pai/blob/master/src/alert-manager/deploy/alert-manager-configmap.yaml.template).

The actions we provide, `email-admin`, `email-user`, `stop-jobs`, `tag-jobs`, can be called within `alert-manager` by sending POST requests to `alert-handler`:
- `localhost:{your_alert_handler_port}/alert-handler/send-email-to-admin`
- `localhost:{your_alert_handler_port}/alert-handler/send-email-to-user`
- `localhost:{your_alert_handler_port}/alert-handler/stop-jobs`
- `localhost:{your_alert_handler_port}/alert-handler/tag-jobs/:tag`

The request body will be automatically filled by `alert-manager` with `webhook`
and `alert-handler` will adapt the requests to various actions.

Please define how to render your customized action to the `alert-handler` API request
[here](https://github.com/microsoft/pai/blob/master/src/alert-manager/src/alert-handler)

Remember to re-build and push the docker image, and restart the `alert-manager` service after your modification with the following commmands in the dev-box container:

```bash
./build/pai_build.py build -c /cluster-configuration/ -s alert-manager
./build/pai_build.py push -c /cluster-configuration/ -i alert-handler
./paictl.py service stop -n alert-manager
./paictl.py config push -p /cluster-configuration -m service
./paictl.py service start -n alert-manager
```
