# 基础管理操作

## 在前端界面上的管理操作

Webportal提供了一些基本的管理功能。 如果以管理员身份登录，则在左侧栏上将找到几个有关管理的按钮，如下图所示：

   <img src="./imgs/administration.png" width="100%" height="100%" /> 

这些功能大多数都很容易理解。 在本节中，我们将快速介绍它们。

### 硬件利用页面

硬件页面显示群集中每个节点的CPU，GPU，内存，磁盘，网络利用率。 利用率基本上以不同的颜色显示。 如果将鼠标悬停在这些彩色圆圈上，将显示确切的利用率百分比。

   <img src="./imgs/hardware.png" width="100%" height="100%" />

### <div id="services-page">服务页面</div>

服务页面显示了Kubernetes中部署的OpenPAI服务。 这些服务是守护程序集，部署集或有状态集。

   <img src="./imgs/services.png" width="100%" height="100%" />


### <div id="user-management">用户管理</div>

用户管理页面使您可以创建，修改和删除用户。 用户有两种类型：非管理员用户和管理员用户。 您可以选择要创建的类型。 仅在以基本身份验证模式（默认模式）部署OpenPAI时才显示此页面。 如果您的集群使用[AAD](./如何管理用户和用户组.md#users-and-groups-in-aad-mode) 来管理用户，则此页面将不可用。

   <img src="./imgs/user-management.png" width="100%" height="100%" />


### 异常任务

主页上为管理员提供了`abnormal jobs`部分。 如果任务运行超过5天或GPU使用率低于10％，则将其视为异常任务。 如果需要，您可以选择停止一些异常工作。

   <img src="./imgs/abnormal-jobs.png" width="100%" height="100%" />

### <div id="access-kubernetes-dashboard">访问Kubernetes仪表盘</div>

Webportal上有一个k8s仪表板的快捷方式。 但是，它需要针对安全问题的特殊身份验证。

   <img src="./imgs/k8s-dashboard.png" width="100%" height="100%" />

要使用它，您首先应该为OpenPAI设置`https`访问（使用`http://<ip>`无效）。 然后，在开发机上，按照以下步骤操作：

**步骤 1.** 将以下Yaml文本另存为`admin-user.yaml`

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system
```

**步骤 2.** 运行 `kubectl apply -f admin-user.yaml`

**步骤 3.** 运行 `kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')`. It will print the token which can be used to login k8s-dashboard.

## <div id="pai-service-management-and-paictl">PAI服务管理和Paictl</div>

一般而言，PAI服务是运行在Kubernetes上的PAI系统创建的守护程序集，部署或状态集。您可以在[k8s仪表板](#access-kubernetes-dashboard)和[服务页面](#services-page)上找到它们。例如，`webportal`是提供前端接口的PAI服务，而`rest-server`是用于后端API的另一个服务。这些服务都是可配置的。如果您遵循[installation-guide](./安装指南.md)，则可以在`dev box machine`上的文件夹`~/pai-deploy/cluster-cfg`中找到两个文件`layout.yaml`和`services-configuration.yaml`。这两个文件是默认服务配置。

`paictl`是一个CLI工具，可帮助您管理集群配置和PAI服务。要使用它，我们建议您利用我们的`dev box docker`映像来避免与环境相关的问题。首先，转到`dev box machine`，通过以下方式启动`dev box docker`。

```bash
sudo docker run -itd \
        -e COLUMNS=$COLUMNS -e LINES=$LINES -e TERM=$TERM \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v ${HOME}/pai-deploy/cluster-cfg:/cluster-configuration  \
        -v ${HOME}/pai-deploy/kube:/root/.kube \
        --pid=host \
        --privileged=true \
        --net=host \
        --name=dev-box \
        openpai/dev-box:<openpai version tag>
```

您应将`<openpai version tag>`替换为当前的OpenPAI版本，例如`v1.0.0`。在命令中，我们将`${HOME}/pai-deploy/kube`挂载到容器中的`/root/.kube`中。因此容器具有正确的配置文件访问Kubernetes。另外，我们在容器中将`${HOME}/pai-deploy/cluster-cfg`（由安装创建的配置）挂载到`/cluster-configuration`中。

要使用`paictl`，请通过以下方式进入容器：

```bash
sudo docker exec -it dev-box bash
```

然后，转到文件夹`/pai`，尝试检索您的集群ID：

```bash
cd /pai
./paictl.py config get-id
```

如果该命令显示您的集群ID，则可以确认`paictl`工具可以正常工作。

这是`paictl`的一些基本用法示例：

```bash
# get cluster id
./paictl.py config get-id

# pull service config to a certain folder
# the configuration containers two files: layout.yaml and services-configuration.yaml
# if <config-folder> already has these files, they will be overrided
./paictl.py config pull -o <config-folder>

# push service config to the cluster
# only pushed config is effective
./paictl.py config push -p <config-folder> -m service

# stop all PAI services
./paictl.py service stop

# start all PAI services
./paictl.py service start

# stop several PAI services
./paictl.py service stop -n <service-name-1> <service-name-2>

# start several PAI services
./paictl.py service start -n <service-name-1> <service-name-2>
```

如果要更改某些服务的配置，请按照`服务停止`，`上传配置`和`服务启动`的步骤进行。

例如，如果要自定义Webportal，则应修改`services-configuration.yaml`中的`webportal`部分。 然后使用以下命令来上传配置并重新启动`Webportal`：

```bash
./paictl.py service stop -n webportal
./paictl.py config push -p <config-folder> -m service
./paictl.py service start -n webportal
```

另一个示例是重新启动整个集群：

```bash
# restart cluster
./paictl.py service stop
./paictl.py service start
```

您可以使用`exit`离开dev-box容器，如果需要的话可以使用`sudo docker exec -it dev-box bash`重新输入。如果您不再需要它，请使用`sudo docker stop dev-box`和`sudo docker rm dev-box`删除Docker容器。