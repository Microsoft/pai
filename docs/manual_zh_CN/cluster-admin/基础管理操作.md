# 基础管理操作

## 在前端界面上的管理操作

Webportal提供了一些基本的管理功能。 如果以管理员身份登录，则在左侧栏上将找到几个有关管理的按钮，如下图所示：

   <img src="./imgs/administration.png" width="100%" height="100%" /> 

这些功能大多数都很容易理解。 在本节中，我们将快速介绍它们。

### 硬件利用页面

硬件页面显示群集中每个节点的CPU，GPU，内存，磁盘，网络利用率。 利用率基本上以不同的颜色显示。 如果将鼠标悬停在这些彩色圆圈上，将显示确切的利用率百分比。

   <img src="./imgs/hardware.png" width="100%" height="100%" />

### <div id="services-page">服务页面</div>

服务页面显示了Kubernetes中部署的OpenPAI服务。 这些服务是守护程序集，部署集或有状态集。

   <img src="./imgs/services.png" width="100%" height="100%" />


### <div id="user-management">用户管理</div>

用户管理页面使您可以创建，修改和删除用户。 用户有两种类型：非管理员用户和管理员用户。 您可以选择要创建的类型。 仅在以基本身份验证模式（默认模式）部署OpenPAI时才显示此页面。 如果您的集群使用[AAD](./如何管理用户和用户组.md#users-and-groups-in-aad-mode) 来管理用户，则此页面将不可用。

   <img src="./imgs/user-management.png" width="100%" height="100%" />


### 异常任务

主页上为管理员提供了`abnormal jobs`部分。 如果作业运行超过5天或GPU使用率低于10％，则将其视为异常作业。 如果需要，您可以选择停止一些异常工作。

   <img src="./imgs/abnormal-jobs.png" width="100%" height="100%" />

### <div id="access-kubernetes-dashboard">访问Kubernetes仪表盘</div>

Webportal上有一个k8s仪表板的快捷方式。 但是，它需要针对安全问题的特殊身份验证。

   <img src="./imgs/k8s-dashboard.png" width="100%" height="100%" />

要使用它，您首先应该为OpenPAI设置`https`访问（使用`http://<ip>`无效）。 然后，在开发机上，按照以下步骤操作：

**Step 1.** Save following yaml text as `admin-user.yaml`

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system
```

**Step 2.** Run `kubectl apply -f admin-user.yaml`

**Step 3.** Run `kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')`. It will print the token which can be used to login k8s-dashboard.

## <div id="pai-service-management-and-paictl">PAI服务管理和Paictl</div>

Generally speaking, PAI services are daemon sets, deployments or stateful sets created by PAI system, running on Kubernetes. You can find them on the [k8s dashboard](#access-kubernetes-dashboard) and [services page](#services-page). For example, `webportal` is a PAI service which provides front-end interface, and `rest-server` is another one for back-end APIs. These services are all configurable. If you have followed the [installation-guide](./安装指南.md), you can find two files, `layout.yaml` and `services-configuration.yaml`, in folder `~/pai-deploy/cluster-cfg` on the dev box machine. These two files are the default service configuration.

`paictl` is a CLI tool which helps you manage cluster configuration and PAI services. To use it, we recommend you to leverage our dev box docker image to avoid environment-related problems. First, go to the dev box machine, launch the dev box docker by:

```bash
sudo docker run -itd \
        -e COLUMNS=$COLUMNS -e LINES=$LINES -e TERM=$TERM \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v ${HOME}/pai-deploy/cluster-cfg:/cluster-configuration  \
        -v ${HOME}/pai-deploy/kube:/root/.kube \
        --pid=host \
        --privileged=true \
        --net=host \
        --name=dev-box \
        openpai/dev-box:<openpai version tag>
```

You should replace the `<openpai version tag>` with your current OpenPAI version, e.g. `v1.0.0`. In the command, we mount `${HOME}/pai-deploy/kube` to `/root/.kube` in the container. Thus the container has correct config file to access Kubernetes. Also, we mount `${HOME}/pai-deploy/cluster-cfg`, the configuration created by installation, to  `/cluster-configuration` in the container.

To use `paictl`, go into the container by:

```bash
sudo docker exec -it dev-box bash
```

Then, go to folder `/pai`, try to retrieve your cluster id:

```bash
cd /pai
./paictl.py config get-id
```

If the command prints your cluster id, you can confirm the `paictl` tool works fine.

Here are some basic usage examples of `paictl`:

```bash
# get cluster id
./paictl.py config get-id

# pull service config to a certain folder
# the configuration containers two files: layout.yaml and services-configuration.yaml
# if <config-folder> already has these files, they will be overrided
./paictl.py config pull -o <config-folder>

# push service config to the cluster
# only pushed config is effective
./paictl.py config push -p <config-folder> -m service

# stop all PAI services
./paictl.py service stop

# start all PAI services
./paictl.py service start

# stop several PAI services
./paictl.py service stop -n <service-name-1> <service-name-2>

# start several PAI services
./paictl.py service start -n <service-name-1> <service-name-2>
```

If you want to change configuration of some services, please follow the steps of `service stop`, `config push` and `service start`.

For example, if you want to customize webportal, you should modify the `webportal` section in `services-configuration.yaml`. Then use the following command to push the configuration and restart webportal:

```bash
./paictl.py service stop -n webportal
./paictl.py config push -p <config-folder> -m service
./paictl.py service start -n webportal
```

Another example is to restart the whole cluster:

```bash
# restart cluster
./paictl.py service stop
./paictl.py service start
```

You can use `exit` to leave the dev-box container, and use `sudo docker exec -it dev-box bash` to re-enter it if you desire so. If you don't need it any more, use `sudo docker stop dev-box` and `sudo docker rm dev-box` to delete the docker container.