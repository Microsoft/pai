prerequisites : 
  - protocol_version : v2
    name : cifar10
    type : data
    version : x.y.z
    contributor : xxx
    description: cifar10 dataset, image classification
    uri : https://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz
  - protocol_version : v2
    name : tensorflow_cnnbenchmarks
    type : script
    version : x.y.z
    contributor : xxx
    description: tensorflow benchmarks
    uri : https://github.com/tensorflow/benchmarks@6a33b4a4b5bda950bb7e45faf13120115cbfdb2f
  - protocol_version : v2
    name : tf_example
    type : dockerimage
    version : x.y.z
    contributor : xxx
    description: python3.5, tensorflow
    uri : openpai/pai.example.tensorflow

job : 
  protocol_version: v2
  name : cifar10_tensorflow
  type : job
  version : x.y.z
  contributor : xxx
  description : image classification, cifar10 dataset, tensorflow, distributed training
  parameters :
    model : resnet20
    batchsize: 32
    num_of_ps: 1
    num_of_worker: 1
    killAllOnCompletedTaskNumber: 1 
    retryCount: 0 

  tasks :
    - name: worker
      data : cifar10
      script : tensorflow_cnnbenchmarks
      dockerimage : tf_example
      resource: 
        instances : $job.parameters.num_of_worker
        resourcePerInstance: {cpu: 2, memoryMB: 16384, gpu: 4}
      env:
        PYTHONPATH : $job.tasks.worker.script/scripts/tf_cnn_benchmarks
      command:
        - pip --quiet install scipy;python $job.tasks.worker.script/scripts/tf_cnn_benchmarks/tf_cnn_benchmarks.py --local_parameter_device=gpu --variable_update=parameter_server --ps_hosts=$PAI_TASK_ROLE_ps_server_HOST_LIST --worker_hosts=$PAI_TASK_ROLE_worker_HOST_LIST --job_name=worker --task_index=$PAI_CURRENT_TASK_ROLE_CURRENT_TASK_INDEX --data_dir=$job.tasks.worker.data --data_name=$job.tasks.worker.data --train_dir=$PAI_OUTPUT_DIR/cifar10_output --model=$job.parameters.model --batch_size=$job.parameters.batchsize
    
    - name : ps_server
      data : cifar10
      script : tensorflow_cnnbenchmarks
      dockerimage : tf_example
      resource :
        instances : $job.parameters.num_of_ps
        resourcePerInstance : { cpu: 2, memoryMB: 8192, gpu: 0 }
        
      env :
        PYTHONPATH : $job.tasks.worker.script/scripts/tf_cnn_benchmarks
                
      command:
        - pip --quiet install scipy;python $job.tasks.worker.script/scripts/tf_cnn_benchmarks/tf_cnn_benchmarks.py --local_parameter_device=cpu --variable_update=parameter_server --ps_hosts=$PAI_TASK_ROLE_ps_server_HOST_LIST --worker_hosts=$PAI_TASK_ROLE_worker_HOST_LIST --job_name=ps --task_index=$PAI_CURRENT_TASK_ROLE_CURRENT_TASK_INDEX --data_dir=$job.tasks.worker.data --data_name=$job.tasks.worker.data --train_dir=$PAI_OUTPUT_DIR/cifar10_output --model=$job.parameters.model --batch_size=$job.parameters.batchsize
